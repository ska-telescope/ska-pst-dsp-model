# SKA PST DSP Model

## Overview

These instructions describe how to compare the results of dspsr's PFB inversion implementation with the PST Signal model implemented in Matlab. The goal of this comparison is to assess whether the two implementations produce the same results, within numerical precision.

For instructions on how to quantify the performance of the Matlab implementation, please see

https://confluence.skatelescope.org/display/SE/Testing+polyphase+filter+bank+inversion+using+MATLAB+model

## Installation

This repo uses Python to process test vectors generated by a Matlab pipeline.

With [poetry](https://poetry.eustace.io/docs/) installed:

    cd python
    poetry install

In order to run tests with the Matlab backend, the [Matlab runtime environment](https://au.mathworks.com/products/compiler/matlab-runtime.html)
must be installed.

## Building

With matlab installed, run `make` to create stand alone executables from
Matlab code.

## Usage

### Matlab

This repo contains Matlab code derived from the PST "Golden" signal chain model. In particular, it contains scripts for channelizing data via oversampled PFB, and performing FFT based polyphase inversion. The FFT based polyphase inversion implementation in this repo is the "Golden" implementation.

In the same way that the Python code in this repo implements a harness to test the purity of the DSPSR PFB inversion implementation, there is a Matlab script ``current_performance.m`` that implements a pipeline for determining the temporal and spectral purity of the "Golden" PST PFB inversion algorithm.


### Polyphase Filterbank Filter Generator

Two approaches to generating Polyphase Filterbank (PFB) filter coefficients have been developed for the SKA. *These two approaches require two different PFB channelizers*. Two separate Matlab scripts encapsulate these two approaches:

- ``design_PFB_FIR_filter.m``: Uses a single stage FIR filter design. This is the script used to develop SKA Low channelizer coefficients. Requires using the PFB implementation in ``polyphase_analysis.m``

- ``design_PFB_FIR_filter_two_stage.m``: Uses a two stage FIR filter design. This is adapted from the script used to develop SKA Mid channelizer coefficients. Requires using the PFB implementation in ``polyphase_analysis_padded.m``. The two stage design allows for generating large (>1e5) numbers of coefficients.


### Polyphase Filterbank Channelizer

The Matlab code in this repo has two different PFB channelizers.

- ``polyphase_analysis.m``: To be used with SKA Low coefficients, or those created by ``design_PFB_FIR_filter.m``. This is derived from code originally put together by John Bunton. This does not zero pad the input data, meaning that the number of output samples is less than (input samples) / (channels * oversampling ratio).
- ``polyphase_analysis_padded.m``: To be used with SKA Mid coefficients, or those created by ``design_PFB_FIR_filter_two_stage.m``. This is derived from code orignally put together by Thushara Gunaratne. This zero pads the input data.


### Polyphase Filterbank Inversion

- polyphase_synthesis.m: This is the Golden FFT based PFB inversion implementation; this is the implementation against which others' correctness is judged.

### Python

The goal of the Python code in this repo is to implement a test harness to test different PFB inversion implementations against each other, and to the test the temporal and spectral purity of the PFB inversion algorithm.

### Testing Python and Matlab "backends"

The ``test_backends.py`` script compares the output of the Matlab and Python PFB channelizers. From the top-level folder

    cd python
    poetry run python -m verify.test_backend

### Testing dspsr and Matlab PFB Inversion implementations

    cd python
    poetry run python -m verify.test_matlab_dspsr_pfb_inversion

Full command line arguments:

    usage: test_matlab_dspsr_pfb_inversion.py [-h] [-t] [-f] [-n N_TEST]
                                          [-c SUB_CONFIG_NAME] [--save-output]
                                          [--extra-args EXTRA_ARGS] [-v] [-s]

    Test DSPSR and Matlab PFB Inversion Implementations
    
    optional arguments:
    -h, --help            show this help message and exit
    -t, --do-time
    -f, --do-freq
    -n N_TEST, --n-test N_TEST
                          Specify the number of test vectors to use
    -c SUB_CONFIG_NAME, --config SUB_CONFIG_NAME
                          Specify which sub configuration to use
    --save-output         Indicate whether to save intermediate products
    --extra-args EXTRA_ARGS
                          Specify any additional arguments to pass to dspsr
    -v, --verbose
    -s, --do-simulated-pulsar


If these tests pass, the program will exit successfully. Moreover, it means that the implementations being tested produce the same result to one part in 1e-6.

We can configure these tests with the `config/test.config.json` file. For example, if we want to turn derippling off in our tests, we change the ``"deripple"`` key from ``true`` to ``false``. See `Validation Configuration`_ for more information on the meaning of all the fields in the ``test.config.json`` file.

### Testing spectral and temporal purity

    cd python
    poetry run python -m verify.test_purity

This code uses the ``"test"`` configuration from ``config/test.config.json`` by default. We can tell the script to do only temporal or spectral purity tests with the ``-t`` and ``-f`` flags respectively.

Full command line arguments:

    cd python
    poetry run python -m verify.test_purity -h
    usage: purity.py [-h] [-t] [-f] [-n N_TEST] [-c SUB_CONFIG_NAME]
                   [--save-output] [--extra-args EXTRA_ARGS] [-v]
                   
    DSPSR PFB inversion purity
    
    optional arguments:
    -h, --help            show this help message and exit
    -t, --do-time
    -f, --do-freq
    -n N_TEST, --n-test N_TEST
                          Specify the number of test vectors to use
    -c SUB_CONFIG_NAME, --config SUB_CONFIG_NAME
                          Specify which sub configuration to use
    --save-output         Indicate whether to save intermediate products
    --extra-args EXTRA_ARGS
                          Specify any additional arguments to pass to dspsr
    -v, --verbose

The ``test_purity.py`` script creates a JSON output file in the ``products`` subdirectory. The name of this file depends on the configuration parameters specified in ``test.config.json``. We can plot the results:

    cd python
    poetry run python -m plot_purity_results.py -i ./../products/report.\*.json

### Testing whether PFB inversion works with dedispersion turned on

    cd python
    poetry run python -m test.test_dedispersion

Validation Configuration
------------------------

``config/test.config.json`` determines what parameters are to run different
implementations of PFB inversion.

- fir_filter_coeff_file_path (str): Relative (to config directory) path to FIR filter coefficients, in .mat format.
- header_file_path (str): Relative (to config directory) path to default header file.
- os_factor (str): Oversampling factor, expressed as "{nu}/{de}"
- channels (int): The number of channels to generate in PFB inversion.
- input_fft_length (int): The size of the forward FFT used in PFB inversion.
- input_overlap (int): The input overlap size used in PFB inversion.
- blocks (int): Number of processing blocks to generate.
- backend: Each of the child fields can either be "python" or "matlab", indicating which implementation to use. Python is (significantly) faster, as there is no call overhead, but Matlab is the prototype "gold standard".
   - test_vectors (str): backend for generating test vectors
   - channelize (str): PFB channelizer backend
   - synthesize (str): PFB inversion backend
- n_pol (int): Number of polarizations to generate
- dm (float): Dispersion measure. Set to zero to disable dedispersion.
- period (float): pulsar period.
- dump_stage (str): Tells dspsr after which stage to dump the results of PFB inversion.
- deripple (bool): Boolean value indicating whether or not to perform derippling.
- fft_window (str): the FFT window to use in PFB inversion. Can be "no_window"
or "tukey"

In order to get sensible results, the FIR filter coefficients must be tuned
to the oversampling factor and the number of PFB channels.
